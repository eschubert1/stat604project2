---
title: "Brain Microarray EDA: Controls vs Features, QC, PCA, Correlations"
author: "Your Name"
date: "`r format(Sys.Date())`"
output:
  html_document:
    toc: true
    toc_float: true
    number_sections: true
    theme: readable
  pdf_document: default
  word_document: default
---

# Overview

This notebook performs exploratory data analysis (EDA) for the brain microarray project. It: - Loads the dataset, builds a combined frame, and splits into **control** (AFFX) and **feature** (non-AFFX) probes.\
- Constructs clean metadata (`meta`) and matrices for controls/features.\
- Produces QC visualizations: per-sample boxplots, sample–sample correlation heatmaps ordered **Lab → Region → Age**, PCA plots, mean–variance, and gene–age correlation histograms.

> **Goal reminder:** Identify genes differentially expressed with respect to age (≥70 vs \<70), with region-specific effects possible.

# Setup

```{r setup, message=FALSE, warning=FALSE}
# Palettes (no external dependency)
library(RColorBrewer)
library(tidyverse); library(matrixStats); library(pheatmap)
pal_blues <- colorRampPalette(c("#f7fbff","#c6dbef","#6baed6","#2171b5","#08306b"))
pal_rdbu  <- colorRampPalette(c("#67001f","#b2182b","#d6604d","#f4a582","#fddbc7",
                                "#f7f7f7",
                                "#d1e5f0","#92c5de","#4393c3","#2166ac","#053061"))

# Make base plots a bit nicer
par(mar = c(4,4,2,1))
```

# Load and Split Data

```{r load_data}
# Load R data objects (arraymeta, expression, genemeta)
load("brain.rda")

# Combine metadata and expression
expr_df <- as.data.frame(expression)
combined <- cbind(arraymeta, expr_df)

# Identify meta vs expression columns
meta_cols <- colnames(arraymeta)
expr_cols <- setdiff(colnames(combined), meta_cols)

# Split controls (AFFX) vs features (others)
affx_cols  <- grep("^AFFX", expr_cols, value = TRUE)
gene_cols  <- setdiff(expr_cols, affx_cols)

control_data <- combined[, c(meta_cols, affx_cols)]
feature_data <- combined[, c(meta_cols, gene_cols)]

dim(control_data)
dim(feature_data)
```

**Why:** control probes capture technical variation; feature probes capture biology. Separating them helps diagnose batch effects while preserving biological signal for DE.

# Build Metadata and Matrices

```{r build_meta_mats}
# Columns per data split
meta_cols <- colnames(arraymeta)
expr_cols_control <- setdiff(colnames(control_data), meta_cols)
expr_cols_feature <- setdiff(colnames(feature_data), meta_cols)

# Build a clean meta with friendly factors
meta <- combined[, meta_cols]
meta$region    <- factor(with(meta, ifelse(region.ancg==1,"ACG",
                                           ifelse(region.dlpfc==1,"DLPFC",
                                                  ifelse(region.cb==1,"Cerebellum", NA)))))
meta$lab       <- factor(with(meta, ifelse(lab.davis==1,"Davis",
                                           ifelse(lab.irvine==1,"Irvine",
                                                  ifelse(lab.michigan==1,"Michigan", NA)))))
meta$age_group <- factor(ifelse(meta$age >= 70, "70plus", "under70"),
                         levels = c("under70","70plus"))
meta$arrayversion <- factor(meta$arrayversion)

# Expression matrices
expr_ctrl <- as.matrix(control_data[, expr_cols_control, drop=FALSE])
expr_feat <- as.matrix(feature_data[, expr_cols_feature, drop=FALSE])

# Quick checks
stopifnot(nrow(expr_ctrl) == nrow(meta), nrow(expr_feat) == nrow(meta))
```

# Helper Functions

```{r helpers}
# Heatmap ordered by Lab -> Region -> Age
plot_cor_heatmap <- function(expr_mat,
                             meta,
                             title = "Sample–sample correlations",
                             lab_levels    = c("Davis","Irvine","Michigan"),
                             region_levels = c("ACG","DLPFC","Cerebellum"),
                             age_levels    = c("under70","70plus"),
                             palette       = NULL) {
  stopifnot(nrow(expr_mat) == nrow(meta))
  meta <- within(meta, {
    lab       <- factor(lab,       levels = lab_levels)
    region    <- factor(region,    levels = region_levels)
    age_group <- factor(age_group, levels = age_levels)
  })
  if (is.null(palette)) {
    palette <- colorRampPalette(c("#f7fbff","#c6dbef","#6baed6","#2171b5","#08306b"))
  }
  cor_mat <- cor(t(expr_mat), use = "pairwise.complete.obs")
  ord <- order(meta$lab, meta$region, meta$age_group, meta$patient)
  cor_ord <- cor_mat[ord, ord, drop = FALSE]
  ann <- data.frame(
    lab       = meta$lab[ord],
    region    = meta$region[ord],
    age_group = meta$age_group[ord]
  )
  rownames(ann) <- rownames(cor_ord)
  grp_lab    <- which(diff(as.integer(meta$lab[ord])) != 0)
  grp_region <- which(diff(interaction(meta$lab[ord], meta$region[ord], drop = TRUE)) != 0)
  grp_age    <- which(diff(interaction(meta$lab[ord], meta$region[ord], meta$age_group[ord], drop = TRUE)) != 0)
  gaps <- sort(unique(c(grp_lab, grp_region, grp_age)))
  if (requireNamespace("pheatmap", quietly = TRUE)) {
    pheatmap::pheatmap(
      cor_ord,
      show_rownames = FALSE, show_colnames = FALSE,
      cluster_rows = FALSE, cluster_cols = FALSE,
      color = palette(100),
      annotation_col = ann, annotation_row = ann,
      gaps_row = gaps, gaps_col = gaps,
      main = title
    )
  } else {
    image(t(cor_ord[nrow(cor_ord):1, ]), col = palette(100),
          axes = FALSE, main = paste0(title, " (base image)"))
    box()
  }
}

# PCA scatter
plot_pca <- function(expr_mat, title_prefix="PCA") {
  pc <- prcomp(expr_mat, center=TRUE, scale.=TRUE)$x[,1:2]
  plot(pc, type="n", xlab="PC1", ylab="PC2",
       main=paste(title_prefix, "- colored by Lab, shapes by Age"))
  cols <- c(Davis="#1b9e77", Irvine="#d95f02", Michigan="#7570b3")[meta$lab]
  pch  <- c(16, 17)[as.integer(meta$age_group)]
  points(pc, col=cols, pch=pch)
  legend("topright", bty="n",
         legend=c("Davis","Irvine","Michigan","<70","≥70"),
         col=c("#1b9e77","#d95f02","#7570b3","black","black"),
         pch=c(16,16,16,16,17))
}

# Mean–Variance (genes)
plot_meanvar <- function(expr_mat, title="Mean–Variance (genes)") {
  gmean <- colMeans(expr_mat, na.rm=TRUE)
  gvar  <- apply(expr_mat, 2, var, na.rm=TRUE)
  plot(gmean, gvar, pch=16, cex=.6, col="#00000055",
       xlab="Gene mean (log)", ylab="Gene variance", main=title)
}

# Gene–age correlations (continuous)
age_cor_hist <- function(expr_mat, title="Gene–age correlations") {
  r <- apply(expr_mat, 2, function(g) suppressWarnings(cor(g, meta$age, use="pairwise")))
  hist(r, breaks=60, main=title, xlab="Pearson r with age")
  invisible(r)
}
```

# Control Probes: QC & Batch Diagnostics

```{r control_qc, fig.width=10, fig.height=6}
# Per-sample distributions
boxplot(data.frame(expr_ctrl), outline=FALSE,
        main="Control probes: per-sample distributions",
        xlab="Samples", ylab="log-expression")

# Correlation heatmap ordered by Lab -> Region -> Age
plot_cor_heatmap(expr_mat = expr_ctrl, meta = meta, title = "Controls: sample–sample correlations")

# PCA (lab/version effects?)
plot_pca(expr_ctrl, title_prefix="Controls PCA")

# Control means by lab/version
ctrl_means <- rowMeans(expr_ctrl, na.rm=TRUE)
par(mfrow = c(1, 2), mar = c(4, 4, 2, 1))
boxplot(ctrl_means ~ meta$lab,
        main = "Control mean by lab",
        xlab = "Lab", ylab = "Mean control expression")
boxplot(ctrl_means ~ meta$arrayversion,
        main = "Control mean by array version",
        xlab = "Array version", ylab = "Mean control expression")
par(mfrow = c(1, 1))
```

# Feature Probes: QC & Exploration

```{r feature_qc, fig.width=10, fig.height=6}
# Per-sample distributions (transpose so each box is a sample)
boxplot(as.data.frame(t(expr_feat)),
        outline = FALSE, xaxt = "n",
        main = "Features: per-sample distributions",
        xlab = "Samples", ylab = "log-expression")

# Correlation heatmap
plot_cor_heatmap(expr_mat = expr_feat, meta = meta, title = "Features: sample–sample correlations")

# PCA
plot_pca(expr_feat, title_prefix="Features PCA")

# Mean–variance
plot_meanvar(expr_feat, title="Features: Mean–Variance")

# Gene–age correlations
r_feat <- age_cor_hist(expr_feat, title="Features: gene–age correlations")
```

# Region-specific PCA (Optional)

```{r region_pca, fig.width=10, fig.height=6}
for (rg in levels(na.omit(meta$region))) {
  idx <- which(meta$region == rg)
  if (length(idx) >= 5) {
    message("Region: ", rg, " (", length(idx), " samples)")
    plot_pca(expr_feat[idx, , drop=FALSE], title_prefix=paste("Features PCA -", rg))
  }
}
```

# Group Difference vs Variability

```{r diff_vs_var, fig.width=7, fig.height=6}
grp <- meta$age_group
m_under <- colMeans(expr_feat[grp=="under70", , drop=FALSE], na.rm=TRUE)
m_70    <- colMeans(expr_feat[grp=="70plus",  , drop=FALSE], na.rm=TRUE)
delta   <- m_70 - m_under
sd_pool <- sqrt((apply(expr_feat[grp=="under70", ], 2, var, na.rm=TRUE) +
                 apply(expr_feat[grp=="70plus",  ], 2, var, na.rm=TRUE))/2)
plot(delta, sd_pool, pch=16, cex=.5, col="#00000040",
     xlab="Mean(≥70) − Mean(<70)", ylab="Pooled SD",
     main="Exploratory: group difference vs variability (Features)")
```

# Optional: ComBat (sva)

```{r combat_install, eval=FALSE}
# Install Bioconductor and sva if needed
# if (!requireNamespace("BiocManager", quietly = TRUE))
#   install.packages("BiocManager")
# BiocManager::install("sva")
```

```{r combat_preview, message=FALSE, warning=FALSE}
if (requireNamespace("sva", quietly = TRUE)) {
  library(sva)
  mod   <- model.matrix(~ age + region, data = meta)
  batch <- meta$lab
  expr_cb <- t(sva::ComBat(dat = t(expr_feat), batch = batch, mod = mod,
                           par.prior = TRUE, prior.plots = FALSE))
  plot_pca(expr_cb, title_prefix="Features PCA (after ComBat)")
} else {
  message("Package 'sva' not available; skipping ComBat preview.")
}
```
